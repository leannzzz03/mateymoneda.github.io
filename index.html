<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mate & Moneda</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
      font-family: 'Gaegu', cursive;
      text-align: center;
      padding: 20px;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    .container { max-width: 400px; margin: 0 auto; position: relative; z-index: 2; }
    h1 {
      font-size: 2.5rem;
      color: #5D4037;
      margin: 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    /* BOTÓN MATE CON IMAGEN DE BASE64 (NO DEPENDE DE IMAGEN EXTERNA) */
    .mate-btn {
      width: 180px;
      height: 180px;
      margin: 30px auto;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="60" r="35" fill="%23D2691E"/><circle cx="50" cy="60" r="30" fill="%23A0522D"/><path d="M45 25 L50 10 L55 25" fill="%23C0C0C0"/><circle cx="50" cy="45" r="8" fill="%23228B22"/><path d="M40 45 Q45 40 50 45 Q55 40 60 45" stroke="%23228B22" stroke-width="2" fill="none"/></svg>') center/contain no-repeat;
      cursor: pointer;
      transition: transform 0.1s;
      animation: float 3s infinite ease-in-out;
    }
    .mate-btn:active { transform: scale(0.95); }
    .stats {
      font-size: 1.5rem;
      color: #8B4513;
      margin: 15px 0;
    }
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 1.1rem;
      border-radius: 50px;
      cursor: pointer;
      margin: 10px 5px;
      font-family: 'Gaegu', cursive;
    }
    .btn:disabled { background: #666; cursor: not-allowed; opacity: 0.7; }
    .pampas {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 120px;
      background: linear-gradient(to top, #7CB342, #8BC34A);
      border-top: 5px solid #558B2F;
      z-index: 1;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body>
  <div class="pampas"></div>
  <div class="container">
    <h1>Mate & Moneda</h1>
    <div class="mate-btn" id="mateBtn"></div>
    <div class="stats">Yerba: <span id="yerba">0</span></div>
    <div class="stats">TON: <span id="ton">0.00</span></div>
    <button class="btn" id="connectWallet">Conectar Wallet</button>
    <button class="btn" id="claimDaily" disabled>Reclamar Diario</button>
    <button class="btn" id="withdraw" disabled>Retirar a TON</button>
  </div>

  <script>
    // === VARIABLES ===
    let yerba = 0;
    let ton = 0;
    const YERBA_PER_TAP = 1;
    const TON_PER_100_YERBA = 0.01;
    const DAILY_BONUS = 10;

    // Elementos
    const yerbaEl = document.getElementById('yerba');
    const tonEl = document.getElementById('ton');
    const mateBtn = document.getElementById('mateBtn');
    const connectBtn = document.getElementById('connectWallet');
    const claimBtn = document.getElementById('claimDaily');
    const withdrawBtn = document.getElementById('withdraw');

    // TON Connect
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://mate-y-moneda.vercel.app/tonconnect-manifest.json'
    });

    // === LOCAL STORAGE ===
    let lastDaily = 0;
    function loadGame() {
      const saved = localStorage.getItem('mateYMoneda');
      if (saved) {
        const data = JSON.parse(saved);
        yerba = data.yerba || 0;
        ton = data.ton || 0;
        lastDaily = data.lastDaily || 0;
      }
      updateUI();
      checkDaily();
    }

    function saveGame() {
      const data = { yerba, ton, lastDaily };
      localStorage.setItem('mateYMoneda', JSON.stringify(data));
    }

    // === UI ===
    function updateUI() {
      yerbaEl.textContent = yerba;
      tonEl.textContent = ton.toFixed(2);
      withdrawBtn.disabled = ton < 0.01;
    }

    // === TAP ===
    mateBtn.addEventListener('click', () => {
      yerba += YERBA_PER_TAP;
      if (yerba % 100 === 0) {
        ton += TON_PER_100_YERBA;
      }
      updateUI();
      saveGame();
      playSound();
      Telegram.WebApp.HapticFeedback.impactOccurred('light');
    });

    // === SONIDO ===
    function playSound() {
      const audio = new Audio('data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA...'); // Sonido corto embebido
      audio.volume = 0.3;
      audio.play().catch(() => {});
    }

    // === RECOMPENSA DIARIA ===
    function checkDaily() {
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000;
      if (now - lastDaily > oneDay) {
        claimBtn.disabled = false;
        claimBtn.textContent = `Reclamar ${DAILY_BONUS} Yerba`;
      } else {
        const remaining = Math.ceil((oneDay - (now - lastDaily)) / 1000);
        const hours = Math.floor(remaining / 3600);
        const mins = Math.floor((remaining % 3600) / 60);
        claimBtn.disabled = true;
        claimBtn.textContent = `Espera ${hours}h ${mins}m`;
        setTimeout(checkDaily, 60000);
      }
    }

    claimBtn.addEventListener('click', () => {
      if (!claimBtn.disabled) {
        yerba += DAILY_BONUS;
        lastDaily = Date.now();
        updateUI();
        saveGame();
        checkDaily();
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      }
    });

    // === WALLET ===
    connectBtn.addEventListener('click', async () => {
      try {
        await tonConnectUI.connectWallet();
        connectBtn.textContent = 'Conectado';
        connectBtn.disabled = true;
      } catch (e) {
        Telegram.WebApp.showAlert('Error. Usa TON Wallet en testnet.');
      }
    });

    // === RETIRAR ===
    withdrawBtn.addEventListener('click', () => {
      if (ton >= 0.01) {
        Telegram.WebApp.showAlert(`¡Retirando ${ton.toFixed(2)} TON! (Testnet)`);
        ton = 0;
        updateUI();
        saveGame();
      }
    });

    // === INICIO ===
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    loadGame();

    // Guardar al salir
    window.addEventListener('beforeunload', saveGame);
  </script>
</body>
</html>